<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOH Project Dashboard V2.1 | Fixed Version</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg-app: #f1f5f9; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg-app); color: #334155; }
        
        /* Status Colors */
        .bg-status-red { background-color: #ef4444; color: white; }
        .bg-status-yellow { background-color: #f59e0b; color: white; }
        .bg-status-green { background-color: #10b981; color: white; }
        .bg-status-gray { background-color: #94a3b8; color: white; }

        /* UI Elements */
        .nav-btn { cursor: pointer; padding: 12px 20px; border-radius: 8px; font-weight: 500; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-btn:hover { background-color: rgba(255,255,255,0.1); }
        .nav-btn.active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }

        .kpi-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid; }
        
        #map { height: 600px; width: 100%; border-radius: 12px; z-index: 1; }
        
        /* Table */
        .custom-table th { background-color: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; padding: 12px; text-align: left; }
        .custom-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; }
        .custom-table tr:hover { background-color: #f8fafc; }

        /* Loader & Error */
        .loader-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .error-msg { color: #ef4444; margin-top: 10px; font-size: 0.9rem; max-width: 400px; }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <h2 class="text-xl font-bold text-slate-700">Connecting to DOH Database...</h2>
        <p class="text-sm text-slate-500 mb-4">Syncing Google Sheets via Secure Proxy</p>
        <div id="error-container" class="hidden">
            <p class="error-msg" id="error-text"></p>
            <button onclick="loadDemoData()" class="mt-4 px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-900 transition text-sm">
                ใช้ข้อมูลตัวอย่าง (Demo Data)
            </button>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        
        <aside class="w-64 bg-slate-900 text-white flex-shrink-0 hidden md:flex flex-col">
            <div class="p-6 border-b border-slate-700">
                <h1 class="text-lg font-bold flex items-center gap-2">
                    <i class="fa-solid fa-tower-broadcast text-blue-400"></i> CONTROL TOWER
                </h1>
                <p class="text-xs text-slate-400 mt-1 pl-7">DOH Network Project</p>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <div class="nav-btn active" onclick="switchTab('overview', this)">
                    <i class="fa-solid fa-chart-line"></i> Overview
                </div>
                <div class="nav-btn" onclick="switchTab('control', this)">
                    <i class="fa-solid fa-table-list"></i> Project Control
                </div>
                <div class="nav-btn" onclick="switchTab('team', this)">
                    <i class="fa-solid fa-users-gear"></i> Team Tracking
                </div>
                <div class="nav-btn" onclick="switchTab('map', this)">
                    <i class="fa-solid fa-map-location-dot"></i> Live Map
                </div>
            </nav>
            <div class="p-4 border-t border-slate-700 text-xs text-slate-400">
                <p>Version 2.1 (Fixed)</p>
                <div class="mt-2 flex items-center gap-2">
                     <div class="w-2 h-2 rounded-full bg-green-500"></div> Online
                </div>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-slate-50">
            
            <header class="bg-white shadow-sm p-4 sticky top-0 z-20 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button class="md:hidden text-slate-600"><i class="fa-solid fa-bars text-xl"></i></button>
                    <h2 class="text-lg font-bold text-slate-800" id="page-title">Executive Overview</h2>
                </div>
                <div class="flex gap-3">
                    <input type="file" id="csvUpload" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                    <button onclick="document.getElementById('csvUpload').click()" class="bg-white border border-slate-300 text-slate-600 px-3 py-2 rounded text-sm hover:bg-slate-50">
                        <i class="fa-solid fa-upload mr-1"></i> Upload CSV
                    </button>
                    <select id="filter-region" onchange="applyFilters()" class="bg-slate-100 border-none rounded px-3 py-2 text-sm font-medium focus:ring-2 focus:ring-blue-500">
                        <option value="All">All Regions</option>
                    </select>
                    <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm font-medium transition">
                        <i class="fa-solid fa-rotate mr-1"></i> Refresh
                    </button>
                </div>
            </header>

            <div class="p-6 max-w-[1600px] mx-auto">
                
                <div id="tab-overview" class="tab-content space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="kpi-card border-blue-500">
                            <p class="text-xs font-bold text-slate-400 uppercase">Total Sites</p>
                            <div class="flex justify-between items-end">
                                <h3 class="text-4xl font-bold text-slate-800" id="kpi-total">0</h3>
                                <i class="fa-solid fa-server text-blue-200 text-3xl"></i>
                            </div>
                        </div>
                        <div class="kpi-card border-green-500">
                            <p class="text-xs font-bold text-slate-400 uppercase">Overall Progress</p>
                            <div class="flex justify-between items-end">
                                <h3 class="text-4xl font-bold text-green-600" id="kpi-progress">0%</h3>
                                <div class="text-right">
                                    <p class="text-xs text-slate-400">Target: 100%</p>
                                    <p class="text-xs font-bold text-green-600" id="kpi-completed-count">0 Done</p>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card border-red-500">
                            <p class="text-xs font-bold text-slate-400 uppercase">Critical Delays</p>
                            <div class="flex justify-between items-end">
                                <h3 class="text-4xl font-bold text-red-600" id="kpi-delay">0</h3>
                                <div class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold">Action Req.</div>
                            </div>
                        </div>
                        <div class="kpi-card border-orange-500">
                            <p class="text-xs font-bold text-slate-400 uppercase">Active Phase</p>
                            <div class="flex justify-between items-end">
                                <h3 class="text-2xl font-bold text-slate-800" id="kpi-phase-focus">-</h3>
                                <i class="fa-solid fa-wrench text-orange-200 text-3xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm lg:col-span-2">
                            <h3 class="font-bold text-slate-700 mb-4">Schedule Performance (S-Curve)</h3>
                            <div id="chart-scurve"></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4">Current Status</h3>
                            <div id="chart-donut"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-control" class="tab-content hidden space-y-4">
                    <div class="flex gap-2">
                        <button onclick="filterTable('All')" class="px-4 py-2 bg-white border rounded shadow-sm hover:bg-slate-50 text-sm">Show All</button>
                        <button onclick="filterTable('Delay')" class="px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded shadow-sm hover:bg-red-100 font-bold text-sm">Show Delays Only</button>
                        <button onclick="filterTable('Handover')" class="px-4 py-2 bg-green-50 text-green-600 border border-green-200 rounded shadow-sm hover:bg-green-100 text-sm">Show Completed</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                        <div class="overflow-x-auto max-h-[600px]">
                            <table class="w-full custom-table">
                                <thead class="sticky top-0 bg-slate-50 shadow-sm z-10">
                                    <tr>
                                        <th>Site Name</th>
                                        <th>Region</th>
                                        <th>Phase</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Plan Handover</th>
                                        <th>Delay</th>
                                        <th>Team</th>
                                    </tr>
                                </thead>
                                <tbody id="table-control-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-team" class="tab-content hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4">Team Workload</h3>
                            <div id="chart-team-load"></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                             <h3 class="font-bold text-slate-700 mb-4">Engineer Performance</h3>
                             <div id="chart-eng-load"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-map" class="tab-content hidden h-full">
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="mb-4 flex gap-4 text-xs font-bold">
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-status-green"></span> Completed</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-status-yellow"></span> In Progress</span>
                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-status-red"></span> Delay</span>
                        </div>
                        <div id="map"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // --- CONFIG ---
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS4ifV8dahhTG3SYy-NL7rz2HNkAYGI-n79_JcVW97jGyOqAZ2rq10slKgZjGfD6Q/pub?output=csv';
        // ใช้ Proxy เพื่อแก้ปัญหาเปิดไฟล์แล้วค้าง (CORS)
        const PROXY_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(SHEET_CSV_URL);

        let rawData = [];
        let filteredData = [];
        let charts = {};
        let map, markers = [];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            fetchData();
            setInterval(fetchData, 300000); // 5 mins auto-refresh
        });

        // --- DATA ENGINE ---
        async function fetchData() {
            const loader = document.getElementById('loader');
            const errContainer = document.getElementById('error-container');
            
            loader.style.display = 'flex';
            errContainer.classList.add('hidden');

            try {
                // 1. ลองโหลดผ่าน Proxy ก่อน (เพื่อแก้ปัญหา Local File)
                let response = await fetch(PROXY_URL);
                if (!response.ok) {
                    // 2. ถ้า Proxy ล่ม ลองโหลดตรง (กรณีเปิดบน Server)
                    console.warn("Proxy failed, trying direct...");
                    response = await fetch(SHEET_CSV_URL);
                }
                
                if (!response.ok) throw new Error("Network response was not ok");
                
                const csvText = await response.text();
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        processData(results.data);
                        loader.style.display = 'none';
                    }
                });

            } catch (error) {
                console.error("Fetch Error:", error);
                document.querySelector('.animate-spin').style.display = 'none';
                errContainer.classList.remove('hidden');
                document.getElementById('error-text').innerText = "ไม่สามารถเชื่อมต่อ Google Sheets ได้\n(อาจเกิดจาก Internet หรือ CORS Policy)";
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                Papa.parse(e.target.result, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => processData(results.data)
                });
            };
            reader.readAsText(file);
        }

        // --- LOGIC PROCESSOR ---
        function processData(data) {
            const today = new Date();
            
            rawData = data.map(row => {
                // Safe extraction
                const phase = row.phase || 'Survey';
                let status = row.status || 'Not Start';
                const planDate = row.plan_handover ? new Date(row.plan_handover) : null;
                
                // AUTO PROGRESS LOGIC
                let progress = 0;
                if(status.toLowerCase().includes('handover complete') || (phase === 'Handover' && status === 'Complete')) progress = 100;
                else if(status.toLowerCase().includes('install complete') || (phase === 'Install' && status === 'Complete')) progress = 80;
                else if(status.toLowerCase().includes('survey complete') || (phase === 'Survey' && status === 'Complete')) progress = 30;
                else if(phase === 'Install') progress = 40;
                else if(phase === 'Handover') progress = 90;
                
                // FORCE COMPLETE OVERRIDE
                if(progress === 100) status = 'Handover Complete';

                // DELAY LOGIC
                let isDelay = false;
                let delayDays = 0;
                if(progress < 100 && planDate && today > planDate) {
                    isDelay = true;
                    delayDays = Math.ceil((today - planDate) / (1000 * 60 * 60 * 24));
                }

                // COLOR LOGIC
                let color = '#94a3b8'; // Gray
                if(isDelay) color = '#ef4444'; // Red
                else if(progress === 100) color = '#10b981'; // Green
                else if(progress > 0) color = '#f59e0b'; // Yellow

                return {
                    ...row,
                    progress, isDelay, delayDays, color,
                    cleanStatus: status,
                    lat: parseFloat(row.lat),
                    lng: parseFloat(row.lng)
                };
            }).filter(d => d.site_name);

            // Setup Filter
            const regionSel = document.getElementById('filter-region');
            const regions = [...new Set(rawData.map(d => d.region).filter(r => r))];
            if(regionSel.options.length === 1) {
                regions.forEach(r => regionSel.add(new Option(r, r)));
            }

            applyFilters();
        }

        function applyFilters() {
            const region = document.getElementById('filter-region').value;
            filteredData = rawData.filter(d => region === 'All' || d.region === region);
            updateUI();
        }

        // --- RENDERERS ---
        function updateUI() {
            document.getElementById('loader').style.display = 'none';
            renderKPI();
            renderCharts();
            renderTable(filteredData);
            renderMap();
        }

        function renderKPI() {
            const total = filteredData.length;
            const done = filteredData.filter(d => d.progress === 100).length;
            const delay = filteredData.filter(d => d.isDelay).length;
            const avg = total ? Math.round(filteredData.reduce((a,b)=>a+b.progress,0)/total) : 0;
            
            // Mode Phase
            const phases = filteredData.map(d => d.phase);
            const modePhase = phases.sort((a,b) => phases.filter(v=>v===a).length - phases.filter(v=>v===b).length).pop();

            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-progress').innerText = avg + '%';
            document.getElementById('kpi-completed-count').innerText = done + ' Done';
            document.getElementById('kpi-delay').innerText = delay;
            document.getElementById('kpi-phase-focus').innerText = modePhase || '-';
        }

        function renderCharts() {
            const done = filteredData.filter(d => d.progress === 100).length;
            const delay = filteredData.filter(d => d.isDelay).length;
            const work = filteredData.filter(d => d.progress > 0 && d.progress < 100 && !d.isDelay).length;
            const wait = filteredData.filter(d => d.progress === 0).length;

            updateChart('chart-donut', {
                type: 'donut',
                series: [done, work, delay, wait],
                labels: ['Done', 'Working', 'Delay', 'Pending'],
                colors: ['#10b981', '#f59e0b', '#ef4444', '#94a3b8']
            });

            // S-Curve (Mock)
            updateChart('chart-scurve', {
                type: 'line',
                series: [{ name: 'Plan', data: [10,30,50,70,90,100] }, { name: 'Actual', data: [10,25,40,55, null, null] }],
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                colors: ['#cbd5e1', '#2563eb']
            });

            // Team Load
            const teams = {};
            filteredData.forEach(d => { teams[d.team] = (teams[d.team]||0)+1; });
            updateChart('chart-team-load', {
                type: 'bar',
                series: [{ name: 'Sites', data: Object.values(teams) }],
                labels: Object.keys(teams),
                colors: ['#3b82f6']
            });
            
             // Eng Load
            const engs = {};
            filteredData.forEach(d => { if(d.engineer) engs[d.engineer] = (engs[d.engineer]||0)+1; });
            updateChart('chart-eng-load', {
                type: 'bar',
                series: [{ name: 'Sites', data: Object.values(engs).slice(0,10) }],
                labels: Object.keys(engs).slice(0,10),
                colors: ['#8b5cf6']
            });
        }

        function updateChart(id, config) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new ApexCharts(document.querySelector('#'+id), {
                series: config.series,
                chart: { type: config.type, height: 250, toolbar:{show:false} },
                labels: config.labels,
                colors: config.colors,
                xaxis: { categories: config.labels },
                plotOptions: { bar: { borderRadius:4, horizontal: true }, pie: { donut: { size: '65%' } } }
            });
            charts[id].render();
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-control-body');
            tbody.innerHTML = '';
            data.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="font-bold text-slate-700">${d.site_name}</td>
                    <td class="text-xs text-slate-500">${d.region}</td>
                    <td><span class="px-2 py-1 bg-slate-100 rounded text-xs">${d.phase}</span></td>
                    <td><span class="px-2 py-1 rounded-full text-xs text-white" style="background:${d.color}">${d.cleanStatus}</span></td>
                    <td>
                        <div class="flex items-center gap-2">
                             <div class="w-16 bg-slate-200 h-1.5 rounded-full"><div class="h-1.5 rounded-full bg-blue-600" style="width:${d.progress}%"></div></div>
                             <span class="text-xs">${d.progress}%</span>
                        </div>
                    </td>
                    <td class="text-xs font-mono">${d.plan_handover||'-'}</td>
                    <td class="font-bold text-red-600 text-center">${d.isDelay ? d.delayDays : '-'}</td>
                    <td class="text-xs">${d.team}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterTable(type) {
            let res = filteredData;
            if(type === 'Delay') res = filteredData.filter(d => d.isDelay);
            if(type === 'Handover') res = filteredData.filter(d => d.progress === 100);
            renderTable(res);
        }

        function renderMap() {
            if(!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            filteredData.forEach(d => {
                if(d.lat && d.lng) {
                    const m = L.circleMarker([d.lat, d.lng], {
                        radius: 8, fillColor: d.color, color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.8
                    }).addTo(map);
                    m.bindPopup(`<b>${d.site_name}</b><br>Status: ${d.cleanStatus}<br>Delay: ${d.delayDays} days`);
                    markers.push(m);
                }
            });
        }

        // --- UTILS ---
        function initMap() {
            map = L.map('map').setView([13.7563, 100.5018], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
            if(id === 'map') setTimeout(() => map.invalidateSize(), 300);
        }
        
        // --- DEMO MODE (FALLBACK) ---
        function loadDemoData() {
            console.log("Loading Demo Data...");
            const demo = [
                { site_name: "ทล.เชียงใหม่", region: "ภาคเหนือ", phase: "Survey", status: "Survey Complete", progress: 30, plan_handover: "2024-04-01", team: "Team A", lat: 18.7, lng: 98.9 },
                { site_name: "ทล.ภูเก็ต", region: "ภาคใต้", phase: "Install", status: "Not Start", progress: 0, plan_handover: "2024-03-01", team: "Team B", lat: 7.8, lng: 98.3 },
                { site_name: "ทล.ขอนแก่น", region: "ภาคอีสาน", phase: "Handover", status: "Handover Complete", progress: 100, plan_handover: "2024-01