<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECT MONITORING SYSTEM | DOH Project 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-dark: #0f172a;
            --primary: #1e293b;
            --accent: #2563eb;
            --bg-page: #f1f5f9;
        }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg-page); color: #334155; }
        
        /* Layout & Cards */
        .dashboard-header {
            background: linear-gradient(to right, #0f172a, #1e3a8a);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        /* Navigation */
        .nav-item {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
            color: #94a3b8;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active {
            background: #3b82f6;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
        }

        /* Status Colors (Badges & Map) */
        .st-green { background-color: #10b981; color: white; } /* Completed */
        .st-blue { background-color: #3b82f6; color: white; }  /* WIP */
        .st-yellow { background-color: #facc15; color: #854d0e; } /* Survey */
        .st-red { background-color: #ef4444; color: white; }     /* Delay */
        .st-gray { background-color: #94a3b8; color: white; }    /* Pending */

        /* Map Tweaks */
        #map { height: 650px; width: 100%; border-radius: 12px; z-index: 1; }
        .leaflet-layer { filter: brightness(90%) contrast(110%); } /* Darken Map 10% */

        /* Table */
        .data-table th { background: #f8fafc; color: #475569; padding: 12px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
        .data-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .data-table tr:hover { background: #f8fafc; }
        .clickable-name { color: #2563eb; cursor: pointer; text-decoration: underline; }
        .clickable-name:hover { color: #1e40af; }

        /* Loader */
        .loader-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <h2 class="text-2xl font-bold text-slate-800">Initializing System...</h2>
        <p class="text-slate-500">Connecting to DOH Project 2026 Database</p>
    </div>

    <header class="dashboard-header sticky top-0 z-50">
        <div class="max-w-[1800px] mx-auto px-6 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-white p-2 rounded-lg">
                        <i class="fa-solid fa-road text-3xl text-blue-900"></i>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold leading-tight">PROJECT MONITORING SYSTEM | DOH Project 2026</h1>
                        <p class="text-xs md:text-sm text-blue-200 opacity-90">Operated by Fatima R.B.D.S. International Co., Ltd.</p>
                    </div>
                </div>

                <nav class="flex gap-2 bg-slate-800/50 p-1 rounded-lg backdrop-blur-sm">
                    <div class="nav-item active" onclick="switchTab('overview', this)">
                        <i class="fa-solid fa-chart-pie mr-2"></i>Executive Overview
                    </div>
                    <div class="nav-item" onclick="switchTab('control', this)">
                        <i class="fa-solid fa-table-list mr-2"></i>Project Control
                    </div>
                    <div class="nav-item" onclick="switchTab('team', this)">
                        <i class="fa-solid fa-users-gear mr-2"></i>Team Tracking
                    </div>
                    <div class="nav-item" onclick="switchTab('map', this)">
                        <i class="fa-solid fa-map-location-dot mr-2"></i>Live Map
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-[1800px] mx-auto p-6 space-y-6">

        <div id="tab-overview" class="tab-content animate-fade-in">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="card p-6 flex flex-col items-center relative overflow-hidden">
                    <h3 class="font-bold text-slate-700 mb-2">PHASE 1: SURVEY</h3>
                    <div id="gauge-survey"></div>
                    <div class="absolute bottom-4 text-xs font-bold text-yellow-600 bg-yellow-100 px-3 py-1 rounded-full">Weight: 20%</div>
                </div>
                <div class="card p-6 flex flex-col items-center relative overflow-hidden">
                    <h3 class="font-bold text-slate-700 mb-2">PHASE 2: INSTALL</h3>
                    <div id="gauge-install"></div>
                    <div class="absolute bottom-4 text-xs font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">Weight: 60%</div>
                </div>
                <div class="card p-6 flex flex-col items-center relative overflow-hidden">
                    <h3 class="font-bold text-slate-700 mb-2">PHASE 3: HANDOVER</h3>
                    <div id="gauge-handover"></div>
                    <div class="absolute bottom-4 text-xs font-bold text-green-600 bg-green-100 px-3 py-1 rounded-full">Weight: 20%</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800 border-l-4 border-blue-600 pl-3">Project S-Curve Performance</h3>
                        <span class="text-xs text-slate-500">20 Jan 2026 - 30 Jun 2026</span>
                    </div>
                    <div id="chart-scurve"></div>
                </div>
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800 border-l-4 border-purple-600 pl-3">Regional Performance Analytics</h3>
                        <span class="text-xs text-slate-500">Progress by Region</span>
                    </div>
                    <div id="chart-regional"></div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-orange-500 pl-3 mb-4">Current Site Status Summary</h3>
                <div class="flex flex-col md:flex-row items-center justify-center gap-8">
                    <div id="chart-donut" class="w-full max-w-[400px]"></div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                            <span class="block font-bold text-green-700 text-lg" id="stat-completed">0</span>
                            <span class="text-slate-500">Completed (Green)</span>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                            <span class="block font-bold text-blue-700 text-lg" id="stat-wip">0</span>
                            <span class="text-slate-500">Work In Progress (Blue)</span>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                            <span class="block font-bold text-yellow-700 text-lg" id="stat-survey">0</span>
                            <span class="text-slate-500">Survey Stage (Yellow)</span>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                            <span class="block font-bold text-red-700 text-lg" id="stat-delay">0</span>
                            <span class="text-slate-500">Delayed (Red)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-control" class="tab-content hidden animate-fade-in">
            <div class="card p-6">
                <div class="flex flex-wrap gap-4 mb-4 justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800">Detailed Project Control</h3>
                    <div class="flex gap-2">
                        <select id="filter-region" onchange="applyFilters()" class="border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="All">All Regions</option>
                        </select>
                        <select id="filter-status" onchange="applyFilters()" class="border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="All">All Statuses</option>
                            <option value="Completed">Completed</option>
                            <option value="WIP">Work In Progress</option>
                            <option value="Survey">Survey Stage</option>
                            <option value="Delay">Delay</option>
                        </select>
                        <button onclick="fetchData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm"><i class="fa-solid fa-rotate"></i> Refresh</button>
                    </div>
                </div>
                
                <div class="overflow-x-auto rounded-lg border border-slate-200 max-h-[700px]">
                    <table class="w-full data-table text-left border-collapse">
                        <thead class="sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="w-16">ID</th>
                                <th>Site Name</th>
                                <th>Region</th>
                                <th>Phase</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Team (Click)</th>
                                <th>Engineer (Click)</th>
                                <th>Start Date</th>
                                <th>Target</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-team" class="tab-content hidden animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="card p-6 md:col-span-1">
                    <h3 class="font-bold text-slate-700 mb-4">Team Workload (9 Teams)</h3>
                    <div id="chart-team-bar"></div>
                </div>
                <div class="card p-6 md:col-span-2">
                    <h3 class="font-bold text-slate-700 mb-4">Engineer Workload (18 Engineers)</h3>
                    <div id="chart-eng-bar"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="font-bold text-slate-700 mb-4 text-center">Team Performance Radar</h3>
                    <div id="chart-radar-team"></div>
                </div>
                <div class="card p-6">
                    <h3 class="font-bold text-slate-700 mb-4 text-center">Engineer Capability Radar</h3>
                    <div id="chart-radar-eng"></div>
                </div>
            </div>
        </div>

        <div id="tab-map" class="tab-content hidden animate-fade-in">
            <div class="card p-4">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h3 class="font-bold text-slate-800"><i class="fa-solid fa-satellite-dish mr-2 text-blue-600"></i>Nationwide Installation Sites (138 Sites)</h3>
                    <div class="flex flex-wrap gap-3 text-xs font-bold">
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500"></span> Completed</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-500"></span> Work In Progress</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-yellow-400"></span> Survey Stage</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500"></span> Delay</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-slate-400"></span> Pending</span>
                    </div>
                </div>
                <div id="map"></div>
            </div>
        </div>

    </main>

    <footer class="text-center py-6 text-slate-400 text-sm">
        &copy; 2026 Fatima R.B.D.S. International Co., Ltd. All Rights Reserved.
    </footer>

    <script>
        // CONFIG
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS4ifV8dahhTG3SYy-NL7rz2HNkAYGI-n79_JcVW97jGyOqAZ2rq10slKgZjGfD6Q/pub?output=csv';
        const PROXIES = ['', 'https://api.allorigins.win/raw?url=', 'https://corsproxy.io/?'];
        
        let rawData = [], filteredData = [], map, markers = [];
        let charts = {};

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            fetchData();
        });

        // 1. Data Fetching
        async function fetchData() {
            document.getElementById('loader').style.display = 'flex';
            for (let proxy of PROXIES) {
                try {
                    const res = await fetch(proxy + encodeURIComponent(CSV_URL));
                    if (!res.ok) continue;
                    const text = await res.text();
                    Papa.parse(text, {
                        header: true, skipEmptyLines: true,
                        complete: (results) => {
                            if (results.data.length > 0) {
                                processData(results.data);
                                document.getElementById('loader').style.display = 'none';
                            }
                        }
                    });
                    return;
                } catch (e) { console.error(e); }
            }
            alert("Failed to load data.");
        }

        // 2. Logic Processing (The Brain)
        function processData(data) {
            const today = new Date(); // Feb 2026

            rawData = data.map(row => {
                // Determine Status Logic (Fixing the Gray Map Issue)
                let status = "Pending";
                let progress = 0;
                let colorClass = "st-gray";
                let colorHex = "#94a3b8";

                // Check Dates for Activity
                const surveyDate = row['actual_survey_date'];
                const installDate = row['actual_install_date'];
                const handoverDate = row['actual_handover'];
                const planSurvey = row['plan_survey'] ? new Date(row['plan_survey']) : null;
                const planHandover = row['plan_handover'] ? new Date(row['plan_handover']) : null;

                // Priority Logic
                if (handoverDate || (row['status'] && row['status'].includes('Handover Complete'))) {
                    status = "Completed"; progress = 100;
                    colorClass = "st-green"; colorHex = "#10b981";
                } else if (installDate || (row['status'] && row['status'].includes('Install Complete'))) {
                    status = "Work In Progress"; progress = 60; // Approx
                    colorClass = "st-blue"; colorHex = "#3b82f6";
                } else if (surveyDate || (row['status'] && row['status'].includes('Survey Complete'))) {
                    status = "Survey Stage"; progress = 20;
                    colorClass = "st-yellow"; colorHex = "#facc15";
                } else {
                    // Check Delay
                    if (planSurvey && today > planSurvey) {
                        status = "Delay";
                        colorClass = "st-red"; colorHex = "#ef4444";
                    }
                }

                // Explicit Override from CSV column if needed
                if(row['status'] && row['status'].toLowerCase().includes('delay')) {
                    status = "Delay"; colorClass = "st-red"; colorHex = "#ef4444";
                }

                return {
                    id: row['id'],
                    site: row['site_name'],
                    region: row['region'],
                    team: row['team'],
                    tel_team: row['tel_team'] || 'N/A',
                    eng: row['engineer'],
                    tel_eng: row['tel_eng'] || 'N/A',
                    phase: row['phase'] || 'Survey',
                    status: status,
                    progress: parseInt(row['progress'] || progress),
                    colorClass: colorClass,
                    colorHex: colorHex,
                    lat: parseFloat(row['lat']),
                    lng: parseFloat(row['lng']),
                    start: row['plan_survey'],
                    end: row['plan_handover']
                };
            }).filter(d => d.site); // Remove empty rows

            // Populate Filters
            const regions = [...new Set(rawData.map(d => d.region))];
            const regSel = document.getElementById('filter-region');
            regSel.innerHTML = '<option value="All">All Regions</option>';
            regions.forEach(r => regSel.add(new Option(r, r)));

            applyFilters();
        }

        function applyFilters() {
            const regVal = document.getElementById('filter-region').value;
            const statVal = document.getElementById('filter-status').value;

            filteredData = rawData.filter(d => {
                return (regVal === 'All' || d.region === regVal) &&
                       (statVal === 'All' || (statVal === 'WIP' ? d.status === 'Work In Progress' : d.status.includes(statVal)));
            });

            updateDashboard();
        }

        function updateDashboard() {
            renderGauges();
            renderSCurve();
            renderRegional();
            renderDonut();
            renderTable();
            renderTeamCharts();
            renderMap();
        }

        // --- CHARTS SECTION ---

        function renderGauges() {
            const phases = ['Survey', 'Install', 'Handover'];
            const targets = [138, 138, 138]; // Total sites
            // Count actual completions per phase
            const actuals = [
                filteredData.filter(d => d.progress >= 20).length,
                filteredData.filter(d => d.progress >= 60).length,
                filteredData.filter(d => d.progress === 100).length
            ];
            const colors = ['#facc15', '#3b82f6', '#10b981'];

            phases.forEach((p, i) => {
                const percent = Math.round((actuals[i] / targets[i]) * 100);
                const options = {
                    series: [percent],
                    chart: { type: 'radialBar', height: 200 },
                    plotOptions: {
                        radialBar: {
                            hollow: { size: '60%' },
                            dataLabels: {
                                name: { show: false },
                                value: { fontSize: '24px', fontWeight: 'bold', color: '#1e293b', offsetY: 10 }
                            },
                            track: { background: '#e2e8f0' }
                        }
                    },
                    colors: [colors[i]],
                    labels: [p],
                    stroke: { lineCap: 'round' }
                };
                if(charts[`gauge-${p.toLowerCase()}`]) charts[`gauge-${p.toLowerCase()}`].destroy();
                charts[`gauge-${p.toLowerCase()}`] = new ApexCharts(document.querySelector(`#gauge-${p.toLowerCase()}`), options);
                charts[`gauge-${p.toLowerCase()}`].render();
            });
        }

        function renderSCurve() {
            // Simulated Data for S-Curve (Jan - Jun)
            const categories = ['20 Jan', '10 Feb', '28 Feb', '20 Mar', '10 Apr', '30 Apr', '20 May', '10 Jun', '30 Jun'];
            const planned = [0, 10, 25, 40, 60, 80, 90, 95, 100];
            
            // Calculate Actual based on total progress average
            const currentAvg = filteredData.reduce((a,b)=>a+b.progress,0) / (filteredData.length || 1);
            // Distribute actual curve (Mockup logic based on current progress)
            const actual = planned.map(v => v <= currentAvg ? v : null); 
            if(currentAvg > 0) actual[actual.findIndex(v=>v===null)-1] = currentAvg; // Set last known point

            const options = {
                series: [
                    { name: 'Planned Cumulative %', data: planned, type: 'line' },
                    { name: 'Actual Cumulative %', data: actual, type: 'line' }
                ],
                chart: { height: 350, type: 'line', toolbar: { show: false } },
                stroke: { width: [3, 4], dashArray: [5, 0], curve: 'smooth' }, // Dashed Planned, Solid Actual
                colors: ['#94a3b8', '#2563eb'],
                xaxis: { categories: categories },
                yaxis: { min: 0, max: 100, tickAmount: 10, title: { text: '% Progress' } },
                markers: { size: 5 },
                legend: { position: 'top' },
                grid: { borderColor: '#f1f5f9' }
            };

            if(charts['scurve']) charts['scurve'].destroy();
            charts['scurve'] = new ApexCharts(document.querySelector("#chart-scurve"), options);
            charts['scurve'].render();
        }

        function renderRegional() {
            const regions = [...new Set(filteredData.map(d=>d.region))];
            const data = regions.map(r => {
                const sites = filteredData.filter(d=>d.region===r);
                return Math.round(sites.reduce((a,b)=>a+b.progress,0) / sites.length);
            });

            const options = {
                series: [{ name: 'Progress', data: data }],
                chart: { type: 'bar', height: 350, toolbar: { show: false } },
                plotOptions: { bar: { borderRadius: 4, horizontal: false, columnWidth: '50%' } },
                colors: ['#8b5cf6'],
                xaxis: { categories: regions },
                yaxis: { max: 100 },
                dataLabels: { enabled: true, formatter: (v) => v + "%" }
            };

            if(charts['regional']) charts['regional'].destroy();
            charts['regional'] = new ApexCharts(document.querySelector("#chart-regional"), options);
            charts['regional'].render();
        }

        function renderDonut() {
            const counts = {
                'Completed': filteredData.filter(d=>d.status==='Completed').length,
                'WIP': filteredData.filter(d=>d.status==='Work In Progress').length,
                'Survey': filteredData.filter(d=>d.status==='Survey Stage').length,
                'Delay': filteredData.filter(d=>d.status==='Delay').length
            };
            
            // Update Stat Text
            document.getElementById('stat-completed').innerText = counts.Completed;
            document.getElementById('stat-wip').innerText = counts.WIP;
            document.getElementById('stat-survey').innerText = counts.Survey;
            document.getElementById('stat-delay').innerText = counts.Delay;

            const options = {
                series: [counts.Completed, counts.WIP, counts.Survey, counts.Delay],
                labels: ['Completed', 'Work In Progress', 'Survey Stage', 'Delay'],
                chart: { type: 'donut', height: 300 },
                colors: ['#10b981', '#3b82f6', '#facc15', '#ef4444'],
                plotOptions: { pie: { donut: { size: '70%' } } },
                legend: { show: false }
            };

            if(charts['donut']) charts['donut'].destroy();
            charts['donut'] = new ApexCharts(document.querySelector("#chart-donut"), options);
            charts['donut'].render();
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            filteredData.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="font-mono text-xs bg-slate-100 px-2 py-1 rounded">${d.id}</span></td>
                    <td class="font-bold text-slate-700">${d.site}</td>
                    <td>${d.region}</td>
                    <td>${d.phase}</td>
                    <td>
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${d.progress}%"></div>
                        </div>
                        <span class="text-xs font-bold">${d.progress}%</span>
                    </td>
                    <td><span class="px-3 py-1 rounded-full text-xs font-bold ${d.colorClass}">${d.status}</span></td>
                    <td><span class="clickable-name" onclick="showPopup('${d.team}', '${d.tel_team}')">${d.team}</span></td>
                    <td><span class="clickable-name" onclick="showPopup('${d.eng}', '${d.tel_eng}')">${d.eng}</span></td>
                    <td class="text-xs">${d.start || '-'}</td>
                    <td class="text-xs">${d.end || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 6. Popup Logic
        window.showPopup = (name, tel) => {
            Swal.fire({
                title: `<span class="text-blue-900">${name}</span>`,
                html: `<div class="text-xl my-4"><i class="fa-solid fa-phone-volume text-green-500 mr-2"></i> ${tel}</div>`,
                icon: 'info',
                confirmButtonColor: '#2563eb'
            });
        };

        function renderTeamCharts() {
            // Prepare Data & Extract Nicknames
            const extractNick = (name) => {
                if(!name) return 'Unknown';
                const match = name.match(/\(([^)]+)\)/); // Get text inside ()
                return match ? match[1] : name.split(' ')[0]; // Fallback to first name
            };

            const teams = {};
            const engs = {};

            filteredData.forEach(d => {
                teams[d.team] = (teams[d.team] || 0) + 1;
                engs[d.eng] = (engs[d.eng] || 0) + 1;
            });

            // Workload Bar Charts
            const teamSeries = Object.keys(teams).map(k => ({ x: k, y: teams[k] }));
            const engSeries = Object.keys(engs).map(k => ({ x: extractNick(k), y: engs[k] }));

            const barOptions = (data, color, type='bar') => ({
                series: [{ name: 'Sites', data: data }],
                chart: { type: type, height: 300, toolbar: { show: false } },
                plotOptions: { bar: { borderRadius: 4, horizontal: true } }, // Horizontal for Eng
                colors: [color],
                xaxis: { categories: data.map(d=>d.x) }
            });

            if(charts['teamBar']) charts['teamBar'].destroy();
            charts['teamBar'] = new ApexCharts(document.querySelector("#chart-team-bar"), barOptions(teamSeries, '#3b82f6', 'bar')); // Vertical
            charts['teamBar'].render();

            // 7. Engineer Bar Ratio 1:2 (handled by column width in layout grid)
            if(charts['engBar']) charts['engBar'].destroy();
            charts['engBar'] = new ApexCharts(document.querySelector("#chart-eng-bar"), barOptions(engSeries, '#0ea5e9', 'bar'));
            charts['engBar'].render();

            // 8. Radar Charts
            const radarOptions = (data, color) => ({
                series: [{ name: 'Workload', data: data.map(d=>d.y) }],
                chart: { type: 'radar', height: 300, toolbar: { show: false } },
                labels: data.map(d=>d.x),
                stroke: { width: 2, colors: [color] },
                fill: { opacity: 0.2, colors: [color] },
                markers: { size: 4, colors: ['#fff'], strokeColors: color, strokeWidth: 2 }
            });

            if(charts['radarTeam']) charts['radarTeam'].destroy();
            charts['radarTeam'] = new ApexCharts(document.querySelector("#chart-radar-team"), radarOptions(teamSeries, '#8b5cf6'));
            charts['radarTeam'].render();

            if(charts['radarEng']) charts['radarEng'].destroy();
            charts['radarEng'] = new ApexCharts(document.querySelector("#chart-radar-eng"), radarOptions(engSeries, '#ec4899'));
            charts['radarEng'].render();
        }

        function renderMap() {
            if (!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            filteredData.forEach(d => {
                if (d.lat && d.lng) {
                    const marker = L.circleMarker([d.lat, d.lng], {
                        radius: 8,
                        fillColor: d.colorHex,
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <div class="text-center">
                            <b class="text-blue-900">${d.site}</b><br>
                            <span class="text-xs font-bold px-2 py-0.5 rounded text-white" style="background:${d.colorHex}">${d.status}</span><br>
                            <div class="text-xs mt-1 text-slate-500">Team: ${d.team}</div>
                        </div>
                    `);
                    markers.push(marker);
                }
            });
        }

        // Utils
        function initMap() {
            map = L.map('map').setView([13.7563, 100.5018], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
        }

        window.switchTab = (tabId, btn) => {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
            if(tabId === 'map') setTimeout(() => map.invalidateSize(), 300);
        };
    </script>
</body>
</html>